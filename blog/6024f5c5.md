---
title: K8sé‡‡ç”¨Operatoréƒ¨ç½²redis-clusterå®æˆ˜æŒ‡å—
description: K8sé‡‡ç”¨Operatoréƒ¨ç½²redis-clusterå®æˆ˜æŒ‡å—
published: true
date: '2025-05-10T13:53:34.000Z'
dateCreated: '2025-05-10T13:53:34.000Z'
tags: å®¹å™¨åŒ–
editor: markdown
---

æœ¬æ–‡å°†æŒ‡å¯¼æ‚¨ä½¿ç”¨ Kubernetes Operator åœ¨ K8s é›†ç¾¤ä¸­ï¼Œé«˜æ•ˆéƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„ Redis Clusterã€‚æ­¤æ–¹æ¡ˆåˆ©ç”¨ Redis Operator (æ¥è‡ª Opstree) æ¥è‡ªåŠ¨åŒ– Redis é›†ç¾¤çš„åˆ›å»ºã€é…ç½®å’Œç®¡ç†ï¼Œå®ç°å£°æ˜å¼éƒ¨ç½²ã€‚æˆ‘ä»¬å°†é»˜è®¤é…ç½®3ä¸»3ä»çš„é›†ç¾¤ï¼Œå¹¶åŒæ ·ä¾èµ–é¢„é…ç½®çš„ StorageClass (å¦‚åŸºäº NFS) å®ç°æŒä¹…åŒ–å­˜å‚¨ã€‚

<!-- more -->

---

## ğŸš€ å¼•è¨€ï¼šä¸ºä½•é€‰æ‹© Operator æ¨¡å¼éƒ¨ç½² Redis é›†ç¾¤ï¼Ÿ

åœ¨ Kubernetes ç”Ÿæ€ä¸­ï¼ŒOperator æ¨¡å¼é€šè¿‡å¼•å…¥è‡ªå®šä¹‰èµ„æº (CRD) å’Œè‡ªå®šä¹‰æ§åˆ¶å™¨ï¼Œå°†ç‰¹å®šåº”ç”¨çš„è¿ç»´çŸ¥è¯†ç¼–ç åˆ°è½¯ä»¶ä¸­ï¼Œä»è€Œå®ç°å¤æ‚æœ‰çŠ¶æ€åº”ç”¨çš„è‡ªåŠ¨åŒ–ç®¡ç†ã€‚ç›¸è¾ƒäº Helm Chartï¼ˆé€šå¸¸ä¾§é‡äºåº”ç”¨çš„åˆå§‹éƒ¨ç½²å’Œé…ç½®ï¼‰ï¼ŒOperator æä¾›äº†æ›´æ·±å±‚æ¬¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½åŠ›ï¼ŒåŒ…æ‹¬è‡ªåŠ¨æ‰©ç¼©å®¹ã€ç‰ˆæœ¬å‡çº§ã€æ•…éšœæ¢å¤ã€å¤‡ä»½ç­‰ã€‚

å¯¹äº Redis Cluster è¿™æ ·çš„åˆ†å¸ƒå¼æœ‰çŠ¶æ€æœåŠ¡ï¼ŒOperator èƒ½å¤Ÿï¼š

1.  **ç®€åŒ–éƒ¨ç½²ä¸ç®¡ç†**: é€šè¿‡ä¸€ä¸ªç®€å•çš„ YAML (Custom Resource) å³å¯å®šä¹‰å’Œéƒ¨ç½²æ•´ä¸ªé›†ç¾¤ã€‚
2.  **è‡ªåŠ¨åŒ–è¿ç»´**: Operator ä¼šæŒç»­ç›‘æ§é›†ç¾¤çŠ¶æ€ï¼Œè‡ªåŠ¨å¤„ç†èŠ‚ç‚¹æ•…éšœã€æ•°æ®åŒæ­¥ç­‰é—®é¢˜ã€‚
3.  **é«˜å¯ç”¨æ€§**: ç¡®ä¿ Redis æœåŠ¡åœ¨èŠ‚ç‚¹æ•…éšœæ—¶èƒ½è‡ªåŠ¨åˆ‡æ¢å’Œæ¢å¤ï¼Œä¿éšœä¸šåŠ¡è¿ç»­æ€§ã€‚
4.  **å£°æ˜å¼é…ç½®**: æ‚¨åªéœ€å£°æ˜æœŸæœ›çš„çŠ¶æ€ï¼ŒOperator è´Ÿè´£å°†å…¶å˜ä¸ºç°å®ã€‚

æœ¬æŒ‡å—å°†ä½¿ç”¨ Opstree çš„ Redis Operator æ¥éƒ¨ç½²ä¸€ä¸ªç”Ÿäº§çº§çš„ Redis Clusterã€‚

---

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡ (Prerequisites)

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

1.  **Kubernetes é›†ç¾¤**: ç‰ˆæœ¬ 1.18+ æ¨èã€‚ç¡®ä¿ `kubectl` å·²é…ç½®å¹¶èƒ½æ­£å¸¸è®¿é—®é›†ç¾¤ã€‚
2.  **Helm å®¢æˆ·ç«¯**: ç‰ˆæœ¬ 3.xã€‚Helm å°†ç”¨äºå®‰è£… Redis Operator æœ¬èº«ã€‚
3.  **StorageClass**: é¢„å…ˆé…ç½®å¥½çš„ã€å¯åŠ¨æ€ç”³è¯·æŒä¹…å· (PV) çš„ StorageClassã€‚Redis æ•°æ®å°†æŒä¹…åŒ–åˆ°æ­¤å­˜å‚¨ä¸­ã€‚å¦‚æœæœªæŒ‡å®šï¼Œå°†ä½¿ç”¨é›†ç¾¤çš„é»˜è®¤ StorageClassã€‚

> **ğŸ’¡ æç¤º**
> å¦‚æœæ‚¨å°šæœªé…ç½®åŠ¨æ€å­˜å‚¨ï¼Œå¯ä»¥å‚è€ƒç±»ä¼¼ [Kubernetesä½¿ç”¨Helméƒ¨ç½²NFS-Client-Provisionerå®ç°åŠ¨æ€å­˜å‚¨](https://lbs.wiki/pages/e3673e0e/) çš„æ•™ç¨‹è¿›è¡Œéƒ¨ç½²ã€‚Operator éƒ¨ç½²çš„ Redis Cluster åŒæ ·éœ€è¦å¯é çš„æŒä¹…åŒ–å­˜å‚¨æ¥ä¿å­˜æ•°æ®ã€‚

---

## âš™ï¸æ ¸å¿ƒéƒ¨ç½²æ­¥éª¤

### 1. å®‰è£… Redis Operator

æˆ‘ä»¬å°†ä½¿ç”¨ Helm æ¥å®‰è£… Opstree çš„ Redis Operatorã€‚

```bash
# æ·»åŠ  Opstree Helm ä»“åº“
helm repo add ot-helm https://ot-container-kit.github.io/helm-charts/

# æ›´æ–°æœ¬åœ° Helm ä»“åº“ç´¢å¼•
helm repo update

# å®‰è£… Redis Operator åˆ° 'operator' å‘½åç©ºé—´ (å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º)
helm install redis-operator ot-helm/redis-operator -n ot-operator --create-namespace
```

å®‰è£…å®Œæˆåï¼ŒéªŒè¯ Operator Pod æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

```bash
kubectl get pods -n ot-operator
```

æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡ºï¼ŒOperator Pod å¤„äº `Running` çŠ¶æ€ï¼š

```text
NAME                              READY   STATUS    RESTARTS   AGE
redis-operator-5fbc6c788f-xxxxx   1/1     Running   0          2m
```

### 2. åˆ›å»º Redis è®¿é—®å‡­è¯ (Secret)

Redis é›†ç¾¤éœ€è¦å¯†ç è¿›è¡Œä¿æŠ¤ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª Kubernetes Secret æ¥å­˜å‚¨è¿™ä¸ªå¯†ç ã€‚

é¦–å…ˆï¼Œå‡†å¤‡ `redis-secret.yaml` æ–‡ä»¶ï¼š

```yaml
# redis-secret.yaml
---
apiVersion: v1
kind: Secret
metadata:
  name: redis-secret # æ­¤åç§°å°†åœ¨ RedisCluster CR ä¸­å¼•ç”¨
  # namespace: redis-ns # å»ºè®®ä¸º Redis é›†ç¾¤åˆ›å»ºä¸€ä¸ªä¸“ç”¨å‘½åç©ºé—´
data:
  password: T3BzdHJlZUAxMjM0Cg== # "Opstree@1234" çš„ Base64 ç¼–ç 
type: Opaque
```

> **ğŸ›¡ï¸ å®‰å…¨æç¤ºä¸è¯´æ˜**
> *   `password` å­—æ®µçš„å€¼å¿…é¡»æ˜¯æ‚¨é€‰æ‹©çš„å¯†ç ç»è¿‡ Base64 ç¼–ç åçš„ç»“æœã€‚ä¾‹å¦‚ï¼Œè¦ä½¿ç”¨å¯†ç  `MyStrongP@ssw0rd!`ï¼Œå¯ä»¥æ‰§è¡Œ `echo -n "MyStrongP@ssw0rd!" | base64` æ¥è·å–ç¼–ç åçš„å­—ç¬¦ä¸²ã€‚
> *   å¼ºçƒˆå»ºè®®ä¸ºæ‚¨çš„ Redis é›†ç¾¤åˆ›å»ºä¸€ä¸ªä¸“ç”¨çš„å‘½åç©ºé—´ï¼ˆä¾‹å¦‚ `redis-ns`ï¼‰ï¼Œå¹¶åœ¨ Secret å’Œ RedisCluster CRD ä¸­éƒ½æŒ‡å®šå®ƒã€‚å¦‚æœæœªæŒ‡å®š namespace, èµ„æºå°†åˆ›å»ºåœ¨ `default` å‘½åç©ºé—´ã€‚ä¸ºæ¸…æ™°èµ·è§ï¼Œåç»­æ­¥éª¤å‡è®¾æ‚¨å·²åˆ›å»ºå¹¶ä½¿ç”¨ç‰¹å®šå‘½åç©ºé—´ï¼Œå¦‚`redis-ns`ã€‚
      >     ```bash
      >     kubectl create namespace redis-ns
      >     ```
      >      å¦‚æœæ‚¨ä½¿ç”¨è‡ªå®šä¹‰å‘½åç©ºé—´ï¼Œè¯·åœ¨ `metadata.namespace` å­—æ®µä¸­æŒ‡å®šï¼Œå¹¶åœ¨ `kubectl apply` æ—¶ä½¿ç”¨ `-n redis-ns`ã€‚

åº”ç”¨ Secret é…ç½®ï¼š

```bash
# å¦‚æœä½¿ç”¨äº†è‡ªå®šä¹‰å‘½åç©ºé—´ redis-ns
kubectl apply -f redis-secret.yaml -n redis-ns

# å¦‚æœåœ¨ default å‘½åç©ºé—´
# kubectl apply -f redis-secret.yaml
```

### 3. å®šä¹‰å¹¶åˆ›å»º Redis Cluster (Custom Resource)

ç°åœ¨ï¼Œæˆ‘ä»¬å°†å®šä¹‰ Redis é›†ç¾¤çš„é…ç½®ã€‚åˆ›å»ºä¸€ä¸ªåä¸º `redis-cluster.yaml` çš„æ–‡ä»¶ï¼š

```yaml
# redis-cluster.yaml
---
apiVersion: redis.redis.opstreelabs.in/v1beta2
kind: RedisCluster
metadata:
  name: my-redis-cluster # Redis é›†ç¾¤çš„åç§°
  # namespace: redis-ns # ç¡®ä¿ä¸ Secret åœ¨åŒä¸€å‘½åç©ºé—´
spec:
  clusterSize: 3 # æŒ‡å®šä¸»èŠ‚ç‚¹æ•°é‡ï¼ŒOperator ä¼šè‡ªåŠ¨åˆ›å»º N ä¸» N ä» (æ€»å…± 2N ä¸ª Pod)
  clusterVersion: v7 # å¯ä»¥é€‰æ‹© v6 æˆ– v7ï¼Œç¡®ä¿ä¸ image å…¼å®¹
  podSecurityContext: # Pod çº§åˆ«çš„å®‰å…¨ä¸Šä¸‹æ–‡
    runAsUser: 1000
    fsGroup: 1000
  persistenceEnabled: true # å¯ç”¨æŒä¹…åŒ–
  kubernetesConfig:
    image: quay.io/opstree/redis:v7.0.15 # Redis é•œåƒ
    imagePullPolicy: IfNotPresent
    redisSecret: # å¼•ç”¨ä¸Šé¢åˆ›å»ºçš„ Secret
      name: redis-secret # Secret åç§°
      key: password    # Secret ä¸­å¯†ç å¯¹åº”çš„é”®
  redisExporter: # å†…ç½® Redis Exporter é…ç½®ï¼Œç”¨äºç›‘æ§
    enabled: true
    image: quay.io/opstree/redis-exporter:v1.44.0
  storage: # æŒä¹…åŒ–å­˜å‚¨é…ç½®
    volumeClaimTemplate: # ç”¨äº Redis æ•°æ®
      spec:
        # storageClassName: "nfs-storage" # æ˜ç¡®æŒ‡å®š StorageClassï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤SC
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi # æ¯ä¸ª Redis å®ä¾‹çš„æ•°æ®å·å¤§å°
    nodeConfVolumeClaimTemplate: # ç”¨äº Redis èŠ‚ç‚¹é…ç½®æ–‡ä»¶
      spec:
        # storageClassName: "nfs-storage" # æ˜ç¡®æŒ‡å®š StorageClass
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi # æ¯ä¸ª Redis å®ä¾‹çš„é…ç½®å·å¤§å°
```

> **ğŸ’¡ é…ç½®è¯´æ˜**
> *   `metadata.name`: æ‚¨çš„ Redis é›†ç¾¤çš„åç§°ã€‚
> *   `clusterSize: 3`: è¿™å°†åˆ›å»º 3 ä¸ªä¸»èŠ‚ç‚¹å’Œ 3 ä¸ªä»èŠ‚ç‚¹ï¼ˆæ¯ä¸ªä¸»èŠ‚ç‚¹ä¸€ä¸ªä»èŠ‚ç‚¹ï¼‰ã€‚
> *   `persistenceEnabled: true`: å¼ºçƒˆå»ºè®®ç”Ÿäº§ç¯å¢ƒå¯ç”¨æŒä¹…åŒ–ã€‚
> *   `kubernetesConfig.redisSecret`: å¿…é¡»ä¸æ‚¨ä¹‹å‰åˆ›å»ºçš„ Secret åç§°åŒ¹é…ã€‚
> *   `storage.volumeClaimTemplate.spec.storageClassName`: å¦‚æœæ‚¨æœ‰å¤šä¸ª StorageClassï¼Œæˆ–è€…ä¸æƒ³ä½¿ç”¨é»˜è®¤çš„ï¼Œè¯·åœ¨æ­¤å¤„æ˜ç¡®æŒ‡å®šã€‚å¦‚æœç•™ç©ºæˆ–æ³¨é‡Šæ‰ï¼Œç³»ç»Ÿå°†ä½¿ç”¨æ ‡è®°ä¸º `(default)` çš„ StorageClassã€‚
> *   `redisExporter.enabled: true`: é»˜è®¤å¯ç”¨ Redis Exporterï¼Œæ–¹ä¾¿é›†æˆ Prometheus è¿›è¡Œç›‘æ§ã€‚

éƒ¨ç½² Redis Cluster å®ä¾‹ï¼š

```bash
# å¦‚æœä½¿ç”¨äº†è‡ªå®šä¹‰å‘½åç©ºé—´ redis-ns
kubectl apply -f redis-cluster.yaml -n redis-ns

# å¦‚æœåœ¨ default å‘½åç©ºé—´
# kubectl apply -f redis-cluster.yaml
```
Operator ç°åœ¨ä¼šæ£€æµ‹åˆ°è¿™ä¸ªæ–°çš„ `RedisCluster` èµ„æºï¼Œå¹¶å¼€å§‹åœ¨æŒ‡å®šçš„å‘½åç©ºé—´ä¸­åˆ›å»ºæ‰€éœ€çš„ StatefulSetsã€Servicesã€PVCs ç­‰ç»„ä»¶ã€‚

---

## ğŸ” éªŒè¯ä¸è®¿é—®

### 1. æ£€æŸ¥ Redis Cluster Pod çŠ¶æ€

ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè®© Operator å®Œæˆéƒ¨ç½²ã€‚ç„¶åæ£€æŸ¥ Pod çŠ¶æ€ã€‚å‡è®¾æ‚¨ä½¿ç”¨äº†`redis-ns`å‘½åç©ºé—´ï¼Œå¹¶ä¸”`RedisCluster`çš„`metadata.name`ä¸º`my-redis-cluster`ã€‚

```bash
kubectl get pods -n redis-ns -l redis.redis.opstreelabs.in/cluster-name=my-redis-cluster -w
```

æ‚¨ä¼šçœ‹åˆ° 6 ä¸ª Pod (3 leader/master, 3 follower/slave) é€æ¸è¿›å…¥ `Running` çŠ¶æ€ï¼Œä¸” `READY` è®¡æ•°ä¸º `2/2` (ä¸€ä¸ª Redis å®¹å™¨ï¼Œä¸€ä¸ª Exporter å®¹å™¨)ã€‚

```text
NAME                        READY   STATUS    RESTARTS   AGE
my-redis-cluster-follower-0   2/2     Running   0          3m31s
my-redis-cluster-follower-1   2/2     Running   0          3m27s
my-redis-cluster-follower-2   2/2     Running   0          3m25s
my-redis-cluster-leader-0     2/2     Running   0          3m40s
my-redis-cluster-leader-1     2/2     Running   0          3m36s
my-redis-cluster-leader-2     2/2     Running   0          3m34s
```
æŒ‰ `Ctrl+C` é€€å‡º `-w` (watch) æ¨¡å¼ã€‚

### 2. æ£€æŸ¥ Service çŠ¶æ€

Operator ä¼šä¸º Redis é›†ç¾¤åˆ›å»ºå¤šä¸ª Serviceã€‚

```bash
kubectl get svc -n redis-ns -l redis.redis.opstreelabs.in/cluster-name=my-redis-cluster
```

è¾“å‡ºç¤ºä¾‹ï¼š
```text
NAME                                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE
my-redis-cluster-follower           ClusterIP   10.43.229.199   <none>        6379/TCP,9121/TCP   6m34s
my-redis-cluster-follower-additional ClusterIP   10.43.61.127    <none>        6379/TCP            6m34s
my-redis-cluster-follower-headless  ClusterIP   None            <none>        6379/TCP            6m34s
my-redis-cluster-leader             ClusterIP   10.43.15.7      <none>        6379/TCP,9121/TCP   6m43s
my-redis-cluster-leader-additional  ClusterIP   10.43.80.36     <none>        6379/TCP            6m43s
my-redis-cluster-leader-headless    ClusterIP   None            <none>        6379/TCP            6m43s
```
å…³é”® Serviceï¼š
*   `my-redis-cluster-leader`: ä¸»è¦çš„è¿æ¥å…¥å£ï¼ŒæŒ‡å‘å½“å‰çš„ leader/master èŠ‚ç‚¹ã€‚å®¢æˆ·ç«¯åº”è¿æ¥æ­¤ Serviceã€‚
*   `my-redis-cluster-follower`: æŒ‡å‘ follower/slave èŠ‚ç‚¹ï¼Œç”¨äºè¯»å¯†é›†å‹åœºæ™¯ï¼ˆéœ€è¦å®¢æˆ·ç«¯é…ç½®ï¼‰ã€‚

### 3. æ£€æŸ¥ Secret æ˜¯å¦å¯è¢« Operator è¯»å–

ï¼ˆè¿™ä¸€æ­¥åœ¨ Operator éƒ¨ç½²æ—¶å·²é—´æ¥éªŒè¯ï¼Œè‹¥ Pod æ— æ³•å¯åŠ¨ä¸”æ—¥å¿—æç¤ºè®¤è¯å¤±è´¥ï¼Œåˆ™éœ€æ£€æŸ¥ Secret é…ç½®ï¼‰ã€‚
ä½ å¯ä»¥ç¡®è®¤ Secret å­˜åœ¨ï¼š
```bash
kubectl get secret redis-secret -n redis-ns
```
è¾“å‡ºç¤ºä¾‹ï¼š
```text
NAME           TYPE     DATA   AGE
redis-secret   Opaque   1      10m
```

### 4. è¿æ¥åŠæµ‹è¯•é›†ç¾¤

é¦–å…ˆï¼Œè·å–ä¹‹å‰è®¾ç½®çš„ Redis å¯†ç ï¼š

```bash
# ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ Secret åç§°å’Œå‘½åç©ºé—´
export REDIS_PASSWORD=$(kubectl get secret redis-secret -n redis-ns -o jsonpath="{.data.password}" | base64 --decode)
echo "Redis Password: $REDIS_PASSWORD"
```

ç„¶åï¼Œå¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„ Redis å®¢æˆ·ç«¯ Pod æ¥è¿æ¥é›†ç¾¤ (ä½¿ç”¨ Bitnami çš„ redis-cluster é•œåƒï¼Œå®ƒåŒ…å« `redis-cli`)ï¼š

```bash
# ç¡®ä¿ -n ä¸æ‚¨çš„ Redis é›†ç¾¤éƒ¨ç½²çš„å‘½åç©ºé—´ä¸€è‡´
# --image ç‰ˆæœ¬åº”ä¸æ‚¨çš„ Redis é›†ç¾¤ç‰ˆæœ¬å…¼å®¹æˆ–ä¸€è‡´
kubectl run redis-client -n redis-ns --rm --tty -i \
  --env REDIS_PASSWORD_ENV="$REDIS_PASSWORD" \
  --image docker.io/bitnami/redis-cluster:7.0.15 \
  -- bash
```

åœ¨ä¸´æ—¶ Pod çš„ shell ä¸­ï¼Œä½¿ç”¨ `redis-cli` è¿æ¥åˆ°é›†ç¾¤ Leader Serviceï¼š

```bash
# åœ¨ redis-client Pod å†…éƒ¨æ‰§è¡Œ
# -h å‚æ•°ä½¿ç”¨ <redis-cluster-name>-leader (ä¾‹å¦‚ my-redis-cluster-leader)
# å¦‚æœåœ¨ default å‘½åç©ºé—´ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ my-redis-cluster-leader
# å¦‚æœåœ¨ redis-ns å‘½åç©ºé—´ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ FQDN: my-redis-cluster-leader.redis-ns.svc.cluster.local
redis-cli -c -h my-redis-cluster-leader -a "$REDIS_PASSWORD_ENV"
```
å‚æ•°è¯´æ˜ï¼š
*   `-c`: å¯ç”¨é›†ç¾¤æ¨¡å¼ï¼Œå…è®¸è‡ªåŠ¨é‡å®šå‘ã€‚
*   `-h my-redis-cluster-leader`: Redis é›†ç¾¤çš„ä¸» Service åç§°ã€‚
*   `-a "$REDIS_PASSWORD_ENV"`: ä½¿ç”¨å¯†ç è¿›è¡Œè®¤è¯ã€‚

è¿æ¥æˆåŠŸåï¼Œæ‚¨å¯ä»¥æ‰§è¡Œ Redis å‘½ä»¤æ¥éªŒè¯é›†ç¾¤çŠ¶æ€ï¼š

```
# åœ¨ redis-cli æç¤ºç¬¦ä¸‹æ‰§è¡Œ
> cluster info
# æœŸæœ›çœ‹åˆ°: cluster_state:ok, cluster_slots_assigned:16384, cluster_size:3 (ä¸»èŠ‚ç‚¹æ•°), ...

> cluster nodes
# æœŸæœ›çœ‹åˆ°: åˆ—å‡ºæ‰€æœ‰ 6 ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œ3 ä¸ª master å’Œ 3 ä¸ª slaveï¼ŒåŠå…¶è§’è‰²å’Œè¿æ¥çŠ¶æ€ã€‚

> set mykey "Hello Kubernetes Operator Redis"
# > GET mykey
# "Hello Kubernetes Operator Redis"

> exit
```
æµ‹è¯•å®Œæ¯•åï¼Œåœ¨ `redis-client` Pod çš„ `bash` æç¤ºç¬¦ä¸‹è¾“å…¥ `exit` é€€å‡ºä¸´æ—¶ Podã€‚

### 5. é›†ç¾¤å†…éƒ¨è®¿é—®

åœ¨ Kubernetes é›†ç¾¤å†…éƒ¨ï¼Œå…¶ä»–åº”ç”¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ Service FQDN (å®Œå…¨é™å®šåŸŸå) è®¿é—® Redis é›†ç¾¤ (å‡è®¾éƒ¨ç½²åœ¨ `redis-ns` å‘½åç©ºé—´ï¼Œé›†ç¾¤åä¸º `my-redis-cluster`)ï¼š

*   **ä¸»æœåŠ¡ (ç”¨äºå®¢æˆ·ç«¯å†™å…¥å’Œè¯»å–)**: `my-redis-cluster-leader.redis-ns.svc.cluster.local:6379`
    å¤§å¤šæ•° Redis Cluster å®¢æˆ·ç«¯åº“åªéœ€è¦è¿™ä¸ªåœ°å€å’Œå¯†ç å³å¯è‡ªåŠ¨å‘ç°æ‰€æœ‰èŠ‚ç‚¹ã€‚

---

## ğŸ“ˆ è¿ç»´ä¸è¿›é˜¶

### 1. å¸¸è§é—®é¢˜ä¸æ’æŸ¥ (Troubleshooting)

*   **Operator Pod æœªè¿è¡Œ**: æ£€æŸ¥ `kubectl get pods -n operator` å’Œ `kubectl logs -n operator <operator-pod-name>`ã€‚
*   **RedisCluster CR çŠ¶æ€**: ä½¿ç”¨ `kubectl describe rediscluster my-redis-cluster -n redis-ns` æŸ¥çœ‹ CR çš„çŠ¶æ€å’Œäº‹ä»¶ï¼ŒOperator ä¼šæ›´æ–°è¿™äº›ä¿¡æ¯ã€‚
*   **Redis Pod çŠ¶æ€ Pending**:
    *   æ£€æŸ¥ `kubectl describe pod <redis-pod-name> -n redis-ns`ã€‚
    *   å¯èƒ½æ˜¯ PVC æ— æ³•ç»‘å®š (æ£€æŸ¥ StorageClass é…ç½®ï¼Œç‰¹åˆ«æ˜¯ `storage.volumeClaimTemplate.spec.storageClassName` æ˜¯å¦æ­£ç¡®æˆ–é»˜è®¤SCæ˜¯å¦å¯ç”¨)ã€èµ„æºä¸è¶³ã€‚
*   **Redis Pod CrashLoopBackOff**:
    *   æŸ¥çœ‹ Pod æ—¥å¿—: `kubectl logs <redis-pod-name> -c redis -n redis-ns` (æˆ– `-c redis-exporter`)ã€‚
    *   å¯èƒ½æ˜¯å¯†ç  Secret é…ç½®é”™è¯¯ (`redisSecret.name` æˆ– `redisSecret.key` ä¸åŒ¹é…ï¼Œæˆ–å¯†ç æœ¬èº«é”™è¯¯)ã€æƒé™é—®é¢˜ (æ£€æŸ¥ `podSecurityContext`)ã€‚
*   **è®¤è¯å¤±è´¥ (AUTH failed)**: ç¡®è®¤å®¢æˆ·ç«¯ä½¿ç”¨çš„å¯†ç ä¸ `redis-secret` ä¸­å­˜å‚¨çš„ä¸€è‡´ã€‚
*   **è¿æ¥è¶…æ—¶/æ‹’ç»**:
    *   ç¡®è®¤ Service `my-redis-cluster-leader.redis-ns` æ­£ç¡®æŒ‡å‘å¥åº·çš„ Leader Podsã€‚
    *   æ£€æŸ¥ç½‘ç»œç­–ç•¥ (NetworkPolicies)ã€‚

### 2. Operator ç‰¹æ€§ä¸åç»­ä¼˜åŒ–

Operator æ¨¡å¼ä½¿å¾—è®¸å¤šè¿ç»´ä»»åŠ¡æ›´åŠ ç®€å•ï¼š

*   **èµ„æºç®¡ç†**: Opstree Redis Operator å…è®¸åœ¨å…¶ CRD ä¸­é…ç½®èµ„æºè¯·æ±‚å’Œé™åˆ¶ï¼ˆé€šå¸¸åœ¨ `spec.kubernetesConfig.resources` ä¸‹ï¼Œå…·ä½“éœ€æŸ¥é˜… Operator æ–‡æ¡£æœ€æ–°ç‰ˆ CRD å®šä¹‰ï¼‰ã€‚ä¸º Redis Pod å’Œ Exporter é…ç½®åˆç†çš„èµ„æºæ˜¯ä¿è¯ç¨³å®šæ€§çš„å…³é”®ã€‚
    ```yaml
    # ç¤ºä¾‹: åœ¨ redis-cluster.yaml ä¸­ (éœ€ç¡®è®¤ Operator CRD æ”¯æŒ)
    # spec:
    #   kubernetesConfig:
    #     resources:
    #       requests:
    #         cpu: "500m"
    #         memory: "1Gi"
    #       limits:
    #         cpu: "1"
    #         memory: "2Gi"
    #   redisExporter:
    #     resources:
    #       requests:
    #         cpu: "100m"
    #         memory: "128Mi"
    #       limits:
    #         cpu: "200m"
    #         memory: "256Mi"
    ```
*   **é›†ç¾¤ä¼¸ç¼©**: ä¿®æ”¹ `RedisCluster` CRD ä¸­çš„ `clusterSize` å­—æ®µï¼Œç„¶å `kubectl apply -f redis-cluster.yaml -n redis-ns`ã€‚Operator ä¼šè‡ªåŠ¨å¤„ç†èŠ‚ç‚¹çš„å¢å‡å’Œæ•°æ®é‡åˆ†ç‰‡ã€‚
*   **ç‰ˆæœ¬å‡çº§**: ä¿®æ”¹ `RedisCluster` CRD ä¸­çš„ `kubernetesConfig.image` (æˆ– `clusterVersion`ï¼Œå–å†³äº Operator è®¾è®¡) ä¸ºæ–°ç‰ˆæœ¬ï¼Œç„¶å `kubectl apply`ã€‚Operator ä¼šæ‰§è¡Œæ»šåŠ¨å‡çº§ã€‚
*   **ç›‘æ§å‘Šè­¦**:
    *   ç”±äº `redisExporter.enabled: true`ï¼ŒRedis æŒ‡æ ‡å·²é€šè¿‡ç«¯å£ `9121` æš´éœ²ã€‚
    *   é…ç½® Prometheus æŠ“å–è¿™äº›æŒ‡æ ‡ (é€šå¸¸é€šè¿‡ ServiceMonitor CRDï¼Œå¦‚æœæ‚¨çš„é›†ç¾¤æœ‰ Prometheus Operator)ã€‚
    *   åœ¨ Grafana ä¸­åˆ›å»ºä»ªè¡¨ç›˜å±•ç¤º Redis çŠ¶æ€ã€‚
*   **å¤‡ä»½ä¸æ¢å¤**: æŸ¥é˜… Opstree Redis Operator çš„å®˜æ–¹æ–‡æ¡£ï¼Œçœ‹å…¶æ˜¯å¦æä¾›äº†é€šè¿‡ CRD è¿›è¡Œå¤‡ä»½å’Œæ¢å¤çš„åŠŸèƒ½ã€‚è‹¥æ— ï¼Œåˆ™éœ€ç»“åˆ Redis çš„ RDB/AOF æŒä¹…åŒ–å’Œåº•å±‚å­˜å‚¨çš„å¿«ç…§èƒ½åŠ›ã€‚
*   **å¸è½½é›†ç¾¤**:
    1.  åˆ é™¤ RedisCluster CR: `kubectl delete rediscluster my-redis-cluster -n redis-ns`
    2.  åˆ é™¤ Secret: `kubectl delete secret redis-secret -n redis-ns`
    3.  Operator ä¸€èˆ¬ä¸ä¼šè‡ªåŠ¨åˆ é™¤ PVCã€‚å¦‚æœéœ€è¦å½»åº•æ¸…é™¤æ•°æ®ï¼Œè¯·æ‰‹åŠ¨åˆ é™¤ PVC: `kubectl delete pvc -n redis-ns -l redis.redis.opstreelabs.in/cluster-name=my-redis-cluster`
*   **å¸è½½ Operator**: `helm uninstall redis-operator -n operator`

---

## ğŸ æ€»ç»“

é€šè¿‡æœ¬æŒ‡å—ï¼Œæ‚¨å­¦ä¹ äº†å¦‚ä½•åˆ©ç”¨ Kubernetes Operator (ä»¥ Opstree Redis Operator ä¸ºä¾‹) æ¥éƒ¨ç½²å’Œç®¡ç†ä¸€ä¸ªé«˜å¯ç”¨çš„ Redis Clusterã€‚Operator æ¨¡å¼æå¤§åœ°ç®€åŒ–äº†æœ‰çŠ¶æ€åº”ç”¨çš„è¿ç»´å¤æ‚æ€§ï¼Œä½¿å¾—åœ¨ Kubernetes ä¸Šè¿è¡Œåˆ†å¸ƒå¼ç¼“å­˜æœåŠ¡æ›´ä¸ºé«˜æ•ˆå’Œå¯é ã€‚

å£°æ˜å¼çš„é…ç½®ã€è‡ªåŠ¨åŒ–çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ä»¥åŠä¸ Kubernetes ç”Ÿæ€çš„æ·±åº¦é›†æˆï¼Œä½¿å¾— Operator æˆä¸ºåœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­éƒ¨ç½² Redis ç­‰å…³é”®æœåŠ¡çš„ç†æƒ³é€‰æ‹©ã€‚é¼“åŠ±æ‚¨æ·±å…¥ç ”ç©¶ Operator çš„ CRD é€‰é¡¹å’Œå®˜æ–¹æ–‡æ¡£ï¼Œä»¥å……åˆ†å‘æ˜å…¶æ½œåŠ›ï¼Œæ»¡è¶³æ›´é«˜çº§çš„å®šåˆ¶åŒ–éœ€æ±‚ã€‚

---

## ğŸ“š ç›¸å…³èµ„æºæ¨è

*   **Opstree Redis Operator æ–‡æ¡£**: [åœ¨å…¶ GitHub ä»“åº“æŸ¥æ‰¾](https://github.com/OT-CONTAINER-KIT/redis-operator) (å…·ä½“é“¾æ¥å¯èƒ½éšæ—¶é—´å˜åŒ–)
*   **Kubernetes Operator æ¦‚å¿µ**: [Operator Pattern](https://kubernetes.io/docs/concepts/extend-kubernetes/operator/)
*   **Redis Cluster æ•™ç¨‹**: [Redis Cluster Tutorial](https://redis.io/docs/manual/scaling/)
*   **OperatorHub.io**: [å‘ç°æ›´å¤š Kubernetes Operators](https://operatorhub.io/)

---